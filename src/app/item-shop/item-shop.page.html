<ion-content>

  <ion-toolbar>
    <img src="../../assets/dungeon-logo.png" id="header-logo" (click)="goToMenu()" alt="Dungeon Logo" />
  </ion-toolbar>


  <p class="loading-text" *ngIf="isLoading">
    Loading...
  </p>

  <div *ngIf="!isLoading">
    <div class="shop-info">
      <p class="shop-title">¡Descubre los objetos del día!</p>
      <p class="shop-sub">Cada día nuevos objetos</p>
      <p class="update-date">Actualizado: {{ lastUpdate }}</p>
    </div>

    <div class="user-gold" *ngIf="infoUser">
      <span class="gold-label">Gold:</span>
      <span class="gold-amount">{{ infoUser.coins }}</span>

    </div>

    <div class="items-list">
      <div class="item-card" *ngFor="let item of items">
        <h2>{{ item.name }}</h2>
        <p class="desc" [ngClass]="{'long': (item.description?.length || 0) > 55}">{{ item.description }}</p>
        <div class="price-row">
          <span class="price">{{ item.price }} gold</span>
          <ion-button size="small" (click)="buyItem(item)" [disabled]="!infoUser || infoUser.coins < item.price">
            Comprar
          </ion-button>
        </div>
      </div>
      <div class="item-card call-to-action" *ngIf="items.length === 0">
        <h2>¡Vuelve pronto!</h2>
        <p class="desc">La tienda se está reabasteciendo. Pronto habrá nuevos objetos para ti.</p>
      </div>
    </div>
    <div class="shop-info box-section-title">
      <p class="shop-title">Cofres de Suministros</p>
      <p class="shop-sub">Prueba tu suerte con materiales de calidad</p>
    </div>

    <div class="items-list">
      <div class="item-card loot-box" *ngFor="let tier of ['Madera', 'Hierro', 'Esmeralda']">
        <h2>Caja de Armas de {{ tier }}</h2>
        <div class="box-image-placeholder">
          <span class="img-temp">IMG</span> 
        </div>
        <div class="price-row">
          <ion-button size="small" (click)="buyBox('Arma', tier)" 
            [disabled]="!infoUser || infoUser.coins < (tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125)">
            {{ tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125 }} gold
          </ion-button>
        </div>
      </div>

      <div class="item-card loot-box" *ngFor="let tier of ['Madera', 'Hierro', 'Esmeralda']">
        <h2>Caja de Armadura de {{ tier }}</h2>
        <div class="box-image-placeholder">
          <span class="img-temp">IMG</span>
        </div>
        <div class="price-row">
          <ion-button size="small" (click)="buyBox('Armadura', tier)" 
            [disabled]="!infoUser || infoUser.coins < (tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125)">
            {{ tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125 }} gold
          </ion-button>
        </div>
      </div>

      <div class="item-card loot-box" *ngFor="let tier of ['Madera', 'Hierro', 'Esmeralda']">
        <h2>Caja de Objetos de {{ tier }}</h2>
        <div class="box-image-placeholder">
          <span class="img-temp">IMG</span>
        </div>
        <div class="price-row">
          <ion-button size="small" (click)="buyBox('Objeto', tier)" 
            [disabled]="!infoUser || infoUser.coins < (tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125)">
            {{ tier === 'Madera' ? 35 : tier === 'Hierro' ? 75 : 125 }} gold
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <ion-modal [isOpen]="showCharacterModal" (didDismiss)="cancelPurchase()" class="character-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Selecciona un personaje</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="modal-content">
          <p class="modal-description">
            ¿A qué personaje quieres asignar <strong class="item-name">{{ selectedItem?.name }}</strong>?
          </p>

          <ion-list *ngIf="characters.length > 0" class="character-list">
            <ion-item button *ngFor="let character of characters" (click)="selectCharacter(character)"
              class="character-item" lines="full">
              <ion-label>
                <h2 class="character-name">{{ character.name }}</h2>
                <p class="character-info">{{ character.state.race }}</p>
              </ion-label>
            </ion-item>
          </ion-list>

          <p *ngIf="characters.length === 0" class="no-characters">
            No tienes personajes disponibles
          </p>

          <ion-button expand="block" color="medium" (click)="cancelPurchase()" class="cancel-button">
            Cancelar
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
  

</ion-content>

<ion-modal [isOpen]="showRewardModal" (didDismiss)="closeRewardModal()" class="reward-modal">
  <ng-template>
    <div class="reward-container">
      <div class="sparkles"></div>
      <h1 class="reward-title">¡OBJETO CONSEGUIDO!</h1>
      
      <div class="reward-card" [attr.data-rareza]="newItemGained?.rareza">
        <div class="reward-rareza-tag">{{ newItemGained?.rareza }}</div>
        <h2 class="reward-item-name">{{ newItemGained?.name }}</h2>
        
        <div class="reward-icon-container">
          <ion-icon name="flashlight-outline"></ion-icon> 
        </div>

        <p class="reward-description">{{ newItemGained?.description }}</p>
        
        <div class="reward-footer">
          <span>Valor: {{ newItemGained?.price }} gold</span>
        </div>
      </div>

      <ion-button expand="block" color="warning" (click)="closeRewardModal()" class="claim-button">
        RECOGER OBJETO
      </ion-button>
    </div>
  </ng-template>
</ion-modal>