<ion-content>

  <ion-toolbar>
    <img src="../../assets/dungeon-logo.png" id="header-logo" (click)="goToMenu()" alt="Dungeon Logo" />
  </ion-toolbar>


  <p class="loading-text" *ngIf="isLoading">
    Cargando mercado, usuario y personajes...
  </p>

  <div *ngIf="!isLoading">
    <div class="market-info">
      <h1 class="market-title">Mercado de Items</h1>
      <p class="market-description">Items en venta de otros aventureros</p>
    </div>

    <div class="user-gold" *ngIf="infoUser">
      <span class="gold-label">Gold:</span>
      <span class="gold-amount">{{ infoUser.coins }}</span>
    </div>

    <div class="items-list">
      <div class="item-card" *ngFor="let item of itemsMarket">
        <div class="item-header">
          <h2>{{ item.name }}</h2>
          <span class="rarity-badge" [ngClass]="item.rareza">{{ item.rareza }}</span>
        </div>

        <p class="desc">{{ item.description }}</p>

        <div class="seller-info">
          <span class="seller_name">Vendedor: {{ item.seller_name }}</span>
        </div>

        <div class="price-row">
          <div class="price-block">
            <span class="price market-price">{{ item.market_price }} gold</span>
            <span class="base-price">Precio base: {{ item.price }} gold</span>
          </div>
          <ion-button size="small" (click)="buyItemMarket(item)" *ngIf="item.seller_id !== infoUser?.id">
            Comprar
          </ion-button>
          <ion-button size="small" color="warning" (click)="removeFromMarket(item)"
            *ngIf="item.seller_id === infoUser?.id">
            Retirar
          </ion-button>
        </div>
      </div>

      <div class="item-card call-to-action" *ngIf="itemsMarket.length === 0">
        <h2>Mercado Vacío</h2>
        <p class="desc">Aún no hay objetos en venta de otros jugadores. ¡Sé el primero en publicar!</p>
      </div>
    </div>
  </div>

  <ion-modal [isOpen]="showCharacterModal" (didDismiss)="cancelPurchase()" class="character-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Selecciona un personaje</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="modal-content">
          <p class="modal-description">
            ¿A qué personaje quieres asignar <strong class="item-name">{{ selectedItem?.name }}</strong>?
          </p>

          <ion-list *ngIf="characters.length > 0" class="character-list">
            <ion-item button *ngFor="let character of characters" (click)="confirmBuyItem(character)"
              class="character-item" lines="full">
              <ion-label>
                <h2 class="character-name">{{ character.name }}</h2>
                <p class="character-info">{{ character.state.race}}</p>
              </ion-label>
            </ion-item>
          </ion-list>

          <p *ngIf="characters.length === 0" class="no-characters">
            No tienes personajes disponibles
          </p>

          <ion-button expand="block" color="medium" (click)="cancelPurchase()" class="cancel-button">
            Cancelar
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>